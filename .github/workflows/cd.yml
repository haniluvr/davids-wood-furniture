name: CD Pipeline

# Required GitHub Secrets:
# - EC2_HOST: EC2 instance public IP
# - EC2_USER: EC2 username (usually 'ubuntu')
# - EC2_SSH_KEY: Private SSH key for EC2 access
# - DB_PASSWORD: Database password for davidswood_user
# - MYSQL_ROOT_PASSWORD: MySQL root password

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        npm run build

    - name: Prepare SSH key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
        chmod 600 key.pem

    - name: Test EC2 connection
      run: |
        echo "Testing EC2 connection..."
        echo "EC2 Host: ${{ secrets.EC2_HOST }}"
        echo "EC2 User: ${{ secrets.EC2_USER }}"
        
        # Test SSH connection
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          -o ConnectTimeout=15 -o ServerAliveInterval=5 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'EC2 connection successful'"

    # Prepare directory and set permissions
    - name: Prepare deployment directory
      run: |
        echo "🚀 Preparing deployment directory on EC2..."
        
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'PREPARE_EOF'
        #!/bin/bash
        set -e
        
        APP_DIR="/var/www/html/davids-wood-furniture"
        
        # Create directory if it doesn't exist
        echo "Creating application directory..."
        sudo mkdir -p "$APP_DIR"
        
        # Set proper ownership and permissions BEFORE rsync
        echo "Setting directory permissions..."
        sudo chown -R ubuntu:ubuntu "$APP_DIR"
        sudo chmod -R 775 "$APP_DIR"
        
        echo "✅ Directory prepared with correct permissions"
        PREPARE_EOF

    # Deploy files using rsync
    - name: Deploy with rsync
      run: |
        echo "🚀 Deploying files to EC2..."
        
        # Deploy files using rsync with exclusions
        rsync -avz --delete --progress \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          --exclude='vendor' \
          --exclude='.env' \
          --exclude='.env.local' \
          --exclude='.env.example' \
          --exclude='storage/logs/*.log' \
          --exclude='storage/framework/cache/*' \
          --exclude='storage/framework/sessions/*' \
          --exclude='storage/framework/views/*' \
          --exclude='database/*.sqlite' \
          --exclude='database/*.sql' \
          --exclude='public/build' \
          --exclude='*.log' \
          --exclude='npm-debug.log' \
          --exclude='yarn-debug.log' \
          --exclude='.DS_Store' \
          --exclude='README.md' \
          -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem -o ConnectTimeout=15" \
          ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/html/davids-wood-furniture/
        
        echo "✅ Files deployed successfully"

    # Set proper permissions after rsync deployment
    - name: Set file permissions
      run: |
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'PERMISSIONS_EOF'
        #!/bin/bash
        set -e
        
        echo "🚀 Setting file permissions on EC2..."
        
        APP_DIR="/var/www/html/davids-wood-furniture"
        
        # Set proper ownership and permissions for web server
        echo "Setting file permissions for web server..."
        sudo chown -R www-data:www-data "$APP_DIR"
        sudo chmod -R 755 "$APP_DIR"
        sudo chmod -R 775 "$APP_DIR/storage"
        sudo chmod -R 775 "$APP_DIR/bootstrap/cache"
        
        # Create missing Laravel storage directories
        echo "Creating missing Laravel storage directories..."
        sudo mkdir -p "$APP_DIR/storage/logs" || echo "Storage logs directory creation failed"
        sudo mkdir -p "$APP_DIR/storage/framework/cache" || echo "Storage cache directory creation failed"
        sudo mkdir -p "$APP_DIR/storage/framework/sessions" || echo "Storage sessions directory creation failed"
        sudo mkdir -p "$APP_DIR/storage/framework/views" || echo "Storage views directory creation failed"
        sudo mkdir -p "$APP_DIR/storage/app" || echo "Storage app directory creation failed"
        sudo mkdir -p "$APP_DIR/bootstrap/cache" || echo "Bootstrap cache directory creation failed"
        
        # Set permissions for storage directories
        sudo chown -R www-data:www-data "$APP_DIR/storage" || echo "Storage ownership fix failed"
        sudo chown -R www-data:www-data "$APP_DIR/bootstrap/cache" || echo "Bootstrap cache ownership fix failed"
        sudo chmod -R 775 "$APP_DIR/storage" || echo "Storage permissions fix failed"
        sudo chmod -R 775 "$APP_DIR/bootstrap/cache" || echo "Bootstrap cache permissions fix failed"
        
        echo "✅ File permissions set successfully"
        PERMISSIONS_EOF

    # Install dependencies and run Laravel setup
    - name: Install dependencies and setup Laravel
      run: |
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'SETUP_EOF'
        #!/bin/bash
        set -e
        
        echo "🚀 Installing dependencies and setting up Laravel..."
        
        APP_DIR="/var/www/html/davids-wood-furniture"
        cd "$APP_DIR"
        
        # Install PHP dependencies
        echo "Installing PHP dependencies..."
        sudo -u www-data composer install --no-dev --optimize-autoloader --no-interaction
        
        # Fix npm permissions and create clean environment
        echo "Setting up npm environment..."
        sudo rm -rf /var/www/.npm /var/www/.npmrc /tmp/.npm
        sudo mkdir -p /tmp/.npm
        sudo chown -R www-data:www-data /tmp/.npm
        
        # Set npm environment variables for www-data
        echo "Configuring npm environment..."
        sudo -u www-data bash -c 'export NPM_CONFIG_CACHE=/tmp/.npm && export NPM_CONFIG_PREFIX=/tmp/.npm-global && npm ci'
        
        echo "Building frontend assets..."
        sudo -u www-data bash -c 'export NPM_CONFIG_CACHE=/tmp/.npm && export NPM_CONFIG_PREFIX=/tmp/.npm-global && npm run build'
        
        # Ensure MySQL is running
        echo "Checking MySQL status..."
        sudo systemctl status mysql || echo "MySQL status check failed"
        sudo systemctl start mysql || echo "MySQL start failed"
        
        # Create MySQL user for 127.0.0.1 (required for GitHub Actions environment)
        echo "Creating MySQL user for 127.0.0.1 as root..."
        mysql -u root -p${{ secrets.MYSQL_ROOT_PASSWORD }} -e "CREATE USER IF NOT EXISTS 'davidswood_user'@'127.0.0.1' IDENTIFIED WITH mysql_native_password BY 'StrongPass123!';" || echo "User creation failed, but continuing..."
        mysql -u root -p${{ secrets.MYSQL_ROOT_PASSWORD }} -e "GRANT ALL PRIVILEGES ON davids_wood.* TO 'davidswood_user'@'127.0.0.1';" || echo "Grant privileges failed, but continuing..."
        mysql -u root -p${{ secrets.MYSQL_ROOT_PASSWORD }} -e "FLUSH PRIVILEGES;" || echo "Flush privileges failed, but continuing..."
        
        # Also ensure the database exists
        echo "Creating database if it doesn't exist..."
        mysql -u root -p${{ secrets.MYSQL_ROOT_PASSWORD }} -e "CREATE DATABASE IF NOT EXISTS davids_wood;" || echo "Database creation failed, but continuing..."
        
        # Create .env file with production values
        echo "Creating .env file with production values..."
        sudo tee "$APP_DIR/.env" > /dev/null << 'ENV_EOF'
        APP_NAME="David's Wood Furniture"
        APP_ENV=production
        APP_KEY=base64:YourAppKeyHere
        APP_DEBUG=false
        APP_URL=https://davidswood.shop

        LOG_CHANNEL=stack
        LOG_DEPRECATIONS_CHANNEL=null
        LOG_LEVEL=debug

        DB_CONNECTION=mysql
        DB_HOST=localhost
        DB_PORT=3306
        DB_DATABASE=davids_wood
        DB_USERNAME=davidswood_user
        DB_PASSWORD=StrongPass123!

        BROADCAST_DRIVER=log
        CACHE_DRIVER=file
        FILESYSTEM_DISK=local
        QUEUE_CONNECTION=sync
        SESSION_DRIVER=file
        SESSION_LIFETIME=120

        MEMCACHED_HOST=127.0.0.1

        REDIS_HOST=127.0.0.1
        REDIS_PASSWORD=null
        REDIS_PORT=6379

        MAIL_MAILER=smtp
        MAIL_HOST=mailpit
        MAIL_PORT=1025
        MAIL_USERNAME=null
        MAIL_PASSWORD=null
        MAIL_ENCRYPTION=null
        MAIL_FROM_ADDRESS="hello@example.com"
        MAIL_FROM_NAME="${APP_NAME}"

        AWS_ACCESS_KEY_ID=
        AWS_SECRET_ACCESS_KEY=
        AWS_DEFAULT_REGION=ap-southeast-2
        AWS_BUCKET=
        AWS_USE_PATH_STYLE_ENDPOINT=false

        PUSHER_APP_ID=
        PUSHER_APP_KEY=
        PUSHER_APP_SECRET=
        PUSHER_HOST=
        PUSHER_PORT=443
        PUSHER_SCHEME=https
        PUSHER_APP_CLUSTER=mt1

        VITE_APP_NAME="${APP_NAME}"
        VITE_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
        VITE_PUSHER_HOST="${PUSHER_HOST}"
        VITE_PUSHER_PORT="${PUSHER_PORT}"
        VITE_PUSHER_SCHEME="${PUSHER_SCHEME}"
        VITE_PUSHER_APP_CLUSTER="${PUSHER_APP_CLUSTER}"
        ENV_EOF
        
        # Set proper ownership for .env
        sudo chown www-data:www-data "$APP_DIR/.env"
        sudo chmod 600 "$APP_DIR/.env"
        
        # Clear Laravel caches
        echo "Clearing Laravel caches..."
        sudo -u www-data php artisan config:clear || echo "Config clear failed"
        sudo -u www-data php artisan route:clear || echo "Route clear failed"
        sudo -u www-data php artisan view:clear || echo "View clear failed"
        sudo -u www-data php artisan cache:clear || echo "Cache clear failed"
        
        # Cache configuration for production
        echo "Caching Laravel configuration..."
        sudo -u www-data php artisan config:cache || echo "Config cache failed"
        sudo -u www-data php artisan route:cache || echo "Route cache failed"
        sudo -u www-data php artisan view:cache || echo "View cache failed"
        
        # Run database migrations
        echo "Running database migrations..."
        sudo -u www-data php artisan migrate --force || echo "Migration failed, but continuing..."
        
        # Restart services
        echo "Restarting services..."
        sudo systemctl restart apache2 || echo "Apache restart failed"
        
        # Check and restart PHP-FPM service (try different service names)
        echo "Checking PHP-FPM service..."
        if systemctl list-units --type=service | grep -q "php.*fpm"; then
          echo "Found PHP-FPM service, restarting..."
          sudo systemctl restart php*-fpm || echo "PHP-FPM restart failed"
        else
          echo "No PHP-FPM service found, checking for alternative..."
          sudo systemctl restart php8.1-fpm || sudo systemctl restart php8.2-fpm || sudo systemctl restart php8.3-fpm || echo "PHP-FPM restart failed"
        fi
        
        sudo systemctl restart mysql || echo "MySQL restart failed"
        
        echo "✅ Laravel setup completed successfully"
        SETUP_EOF

    # Configure Apache
    - name: Configure Apache
      run: |
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'APACHE_EOF'
        #!/bin/bash
        set -e
        
        echo "🚀 Configuring Apache..."
        
        # Enable required Apache modules
        echo "Enabling Apache modules..."
        sudo a2enmod rewrite || echo "Rewrite module enable failed"
        sudo a2enmod ssl || echo "SSL module enable failed"
        
        # Update default site document root
        echo "Updating Apache document root..."
        sudo sed -i 's|DocumentRoot /var/www/html|DocumentRoot /var/www/html/davids-wood-furniture/public|' /etc/apache2/sites-available/000-default.conf || echo "Document root update failed"
        
        # Add Laravel-specific Apache configuration
        echo "Adding Laravel Apache configuration..."
        sudo tee -a /etc/apache2/sites-available/000-default.conf > /dev/null << 'APACHE_CONFIG'
        
        # Laravel configuration
        <Directory /var/www/html/davids-wood-furniture/public>
            AllowOverride All
            Require all granted
        </Directory>
        APACHE_CONFIG
        
        # Test Apache configuration
        echo "Testing Apache configuration..."
        sudo apache2ctl configtest || echo "Apache config test failed"
        
        # Restart Apache
        echo "Restarting Apache..."
        sudo systemctl restart apache2 || echo "Apache restart failed"
        
        echo "✅ Apache configuration completed"
        APACHE_EOF

    # Post-deployment health check
    - name: Post-deployment health check
      run: |
        echo "🔍 Running post-deployment health checks..."
        
        # Debug Laravel application
        echo "🔧 Debugging Laravel application..."
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEBUG_EOF'
        #!/bin/bash
        set -e
        
        APP_DIR="/var/www/html/davids-wood-furniture"
        cd "$APP_DIR"
        
        # Check if .env file exists and has content
        echo "=== Checking .env file ==="
        if [ -f "$APP_DIR/.env" ]; then
          echo "✅ .env file exists"
          echo "File size: $(wc -l < "$APP_DIR/.env") lines"
          echo "First few lines:"
          head -5 "$APP_DIR/.env" || echo "Could not read .env file"
        else
          echo "❌ .env file missing"
        fi
        
        # Check Laravel logs
        echo "=== Checking Laravel logs ==="
        if [ -f "$APP_DIR/storage/logs/laravel.log" ]; then
          echo "✅ Laravel log exists"
          echo "Last 10 lines of Laravel log:"
          tail -10 "$APP_DIR/storage/logs/laravel.log" || echo "Could not read Laravel log"
        else
          echo "❌ Laravel log missing"
        fi
        
        # Check Apache error logs
        echo "=== Checking Apache error logs ==="
        echo "Last 10 lines of Apache error log:"
        sudo tail -10 /var/log/apache2/error.log || echo "Could not read Apache error log"
        
        # Test database connection
        echo "=== Testing database connection ==="
        sudo -u www-data php artisan tinker --execute="echo 'DB connection test: '; try { DB::connection()->getPdo(); echo 'SUCCESS'; } catch(Exception \$e) { echo 'FAILED: ' . \$e->getMessage(); }" || echo "Database test failed"
        
        # Check Laravel configuration
        echo "=== Checking Laravel configuration ==="
        sudo -u www-data php artisan config:show | head -20 || echo "Config show failed"
        
        # Test basic Laravel functionality
        echo "=== Testing Laravel functionality ==="
        sudo -u www-data php artisan route:list | head -5 || echo "Route list failed"
        
        # Check for PHP syntax errors
        echo "=== Checking for PHP syntax errors ==="
        find "$APP_DIR" -name "*.php" -exec php -l {} \; 2>&1 | grep -i "error\|fatal" | head -5 || echo "No PHP syntax errors found"
        
        # Check if all required files exist
        echo "=== Checking critical files ==="
        ls -la "$APP_DIR/public/index.php" || echo "❌ index.php missing"
        ls -la "$APP_DIR/vendor/autoload.php" || echo "❌ Composer autoload missing"
        ls -la "$APP_DIR/bootstrap/app.php" || echo "❌ Laravel bootstrap missing"
        
        echo "✅ Debug information collected"
        DEBUG_EOF
        
        # Test website accessibility and get detailed error
        echo "Testing website accessibility..."
        HTTP_CODE=$(curl -f -s -o /dev/null -w "%{http_code}" "http://${{ secrets.EC2_HOST }}" || echo "000")
        echo "HTTP Status Code: $HTTP_CODE"
        
        if [ "$HTTP_CODE" != "200" ]; then
          echo "=== Getting detailed error response ==="
          curl -v "http://${{ secrets.EC2_HOST }}" 2>&1 | head -20 || echo "Could not get detailed response"
          
          echo "=== Checking if it's a PHP error ==="
          curl -s "http://${{ secrets.EC2_HOST }}" | grep -i "fatal\|error\|exception" | head -5 || echo "No obvious PHP errors in response"
        fi
        
        echo "✅ Health checks completed"