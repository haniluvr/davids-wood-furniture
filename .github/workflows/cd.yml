name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options: [production, staging]

jobs:
  deploy:
    # Only run if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build assets
      run: npm run build

    - name: Download frontend build artifacts (if available)
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: public/build/
      continue-on-error: true

    - name: Verify frontend build
      run: |
        if [ -d "public/build" ] && [ "$(ls -A public/build 2>/dev/null)" ]; then
          echo "✅ Using CI artifacts"
        else
          echo "⚠️ CI artifacts not available, will build fresh assets"
          # Ensure build directory exists
          mkdir -p public/build
        fi

    - name: Prepare SSH key
      shell: bash
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
        chmod 600 key.pem
        sed -i 's/\r$//' key.pem
        # More lenient key validation
        if ! head -1 key.pem | grep -q "BEGIN"; then
          echo "Warning: Key format may be invalid, but continuing..."
        fi
        mkdir -p ~/.ssh
        # Add host to known_hosts with error handling
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || echo "Warning: Could not add host to known_hosts"

    - name: Deploy to EC2
      timeout-minutes: 5
      run: |
        # Create .env file from secrets
        cat > .env << 'EOF'
        APP_NAME="David's Wood Furniture"
        APP_ENV=production
        APP_DEBUG=false
        APP_KEY=${{ secrets.APP_KEY }}
        APP_URL=${{ secrets.APP_URL }}

        DB_CONNECTION=mysql
        DB_HOST=localhost
        DB_PORT=3306
        DB_DATABASE=davids_wood
        DB_USERNAME=davidswood_user
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}

        REDIS_HOST=127.0.0.1
        REDIS_PORT=6379
        REDIS_PASSWORD=

        MAIL_MAILER=smtp
        MAIL_HOST=${{ secrets.MAIL_HOST }}
        MAIL_PORT=${{ secrets.MAIL_PORT }}
        MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
        MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
        MAIL_ENCRYPTION=tls
        MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}
        MAIL_FROM_NAME=${{ secrets.MAIL_FROM_NAME }}

        LOG_CHANNEL=stack
        LOG_DEPRECATIONS_CHANNEL=null
        LOG_LEVEL=error
        BROADCAST_DRIVER=log
        CACHE_DRIVER=redis
        QUEUE_CONNECTION=redis
        SESSION_DRIVER=redis
        SESSION_LIFETIME=1440
        FILESYSTEM_DISK=s3
        AWS_ACCESS_KEY_ID=${{ secrets.AWS_S3_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_S3_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION=${{ secrets.AWS_S3_REGION }}
        AWS_BUCKET=${{ secrets.AWS_S3_BUCKET }}

        EOF

        # Test EC2 connection first
        echo "Testing EC2 connection..."
        echo "EC2 Host: ${{ secrets.EC2_HOST }}"
        echo "EC2 User: ${{ secrets.EC2_USER }}"
        echo "Testing connectivity..."
        
        # Test SSH connection (skip ping as it's often blocked)
        echo "Testing SSH connection..."
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          -o ConnectTimeout=15 -o ServerAliveInterval=5 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'EC2 connection successful'"
        
        # Create target directory and copy files in one go
        echo "Creating directory and copying files..."
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          -o ConnectTimeout=15 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p /tmp/davids-wood-furniture-deploy"
        
        # Copy source code and essential assets (exclude heavy directories)
        echo "Copying source code to EC2..."
        rsync -avz --progress \
          --exclude='node_modules' \
          --exclude='vendor' \
          --exclude='.git' \
          --exclude='storage/logs' \
          --exclude='storage/framework/cache' \
          --exclude='storage/framework/sessions' \
          --exclude='storage/framework/views' \
          --exclude='database/*.sqlite' \
          --exclude='database/*.sql' \
          --exclude='public/build' \
          --include='public/admin/**' \
          --include='database/migrations/**' \
          --include='database/seeders/**' \
          --include='database/factories/**' \
          -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem -o ConnectTimeout=15" \
          ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/davids-wood-furniture-deploy/

        # Execute deployment on EC2
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOY_EOF'
        #!/bin/bash
        set -e
        
        echo "🚀 Starting deployment on EC2..."
        
        APP_DIR="/var/www/html/davids-wood-furniture"
        DEPLOY_DIR="/tmp/davids-wood-furniture-deploy"
        
        # Create backup
        echo "Creating backup..."
        if [ -d "$APP_DIR" ]; then
          sudo cp -r "$APP_DIR" "${APP_DIR}_backup_$(date +%Y%m%d_%H%M%S)"
        fi
        
        # Stop Apache temporarily
        echo "Stopping Apache..."
        sudo systemctl stop apache2
        
        # Update application files
        echo "Updating application files..."
        sudo rm -rf "$APP_DIR"
        sudo mv "$DEPLOY_DIR" "$APP_DIR"
        
        # Set proper ownership and permissions
        echo "Setting file permissions..."
        sudo chown -R www-data:www-data "$APP_DIR"
        sudo chmod -R 755 "$APP_DIR"
        sudo chmod -R 775 "$APP_DIR/storage"
        sudo chmod -R 775 "$APP_DIR/bootstrap/cache"
        
        # Ensure composer can write to the directory
        echo "Setting up composer permissions..."
        sudo chmod -R 775 "$APP_DIR"
        sudo chown -R www-data:www-data "$APP_DIR"
        
        # Install PHP dependencies
        echo "Installing PHP dependencies..."
        cd "$APP_DIR"
        sudo -u www-data composer install --no-dev --optimize-autoloader --no-interaction
        
        # Fix npm permissions and create clean environment
        echo "Setting up npm environment..."
        sudo rm -rf /var/www/.npm /var/www/.npmrc /tmp/.npm
        sudo mkdir -p /tmp/.npm
        sudo chown -R www-data:www-data /tmp/.npm
        
        # Set npm environment variables for www-data
        echo "Configuring npm environment..."
        sudo -u www-data bash -c 'export NPM_CONFIG_CACHE=/tmp/.npm && export NPM_CONFIG_PREFIX=/tmp/.npm-global && npm ci'
        
        echo "Building frontend assets..."
        sudo -u www-data bash -c 'export NPM_CONFIG_CACHE=/tmp/.npm && export NPM_CONFIG_PREFIX=/tmp/.npm-global && npm run build'
        
        # Ensure MySQL is running
        echo "Checking MySQL status..."
        sudo systemctl status mysql || echo "MySQL status check failed"
        sudo systemctl start mysql || echo "MySQL start failed"
        
        # Create MySQL user for 127.0.0.1 (required for GitHub Actions environment)
        echo "Creating MySQL user for 127.0.0.1 as root..."
        mysql -u root -pRootPassword123! -e "CREATE USER IF NOT EXISTS 'davidswood_user'@'127.0.0.1' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';" || echo "User creation failed, but continuing..."
        mysql -u root -pRootPassword123! -e "GRANT ALL PRIVILEGES ON davids_wood.* TO 'davidswood_user'@'127.0.0.1';" || echo "Grant privileges failed, but continuing..."
        mysql -u root -pRootPassword123! -e "FLUSH PRIVILEGES;" || echo "Flush privileges failed, but continuing..."
        
        # Also ensure the database exists
        echo "Creating database if it doesn't exist..."
        mysql -u root -pRootPassword123! -e "CREATE DATABASE IF NOT EXISTS davids_wood CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" || echo "Database creation failed, but continuing..."
        
        # Verify the user was created successfully
        echo "Verifying MySQL user creation..."
        mysql -u root -pRootPassword123! -e "SELECT User, Host FROM mysql.user WHERE User='davidswood_user';" || echo "User verification failed, but continuing..."
        
        # Check current .env file on server
        echo "Current .env file database settings:"
        grep "DB_" .env || echo "No DB_ settings found in .env"
        
        # If no DB settings found, recreate the .env file
        if ! grep -q "DB_CONNECTION" .env; then
          echo "Database settings missing from .env, recreating file..."
          cat > .env << 'EOF'
        APP_NAME="David's Wood Furniture"
        APP_ENV=production
        APP_DEBUG=false
        APP_KEY=${{ secrets.APP_KEY }}
        APP_URL=${{ secrets.APP_URL }}

        DB_CONNECTION=mysql
        DB_HOST=localhost
        DB_PORT=3306
        DB_DATABASE=davids_wood
        DB_USERNAME=davidswood_user
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}

        REDIS_HOST=127.0.0.1
        REDIS_PORT=6379
        REDIS_PASSWORD=

        MAIL_MAILER=smtp
        MAIL_HOST=${{ secrets.MAIL_HOST }}
        MAIL_PORT=587
        MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
        MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
        MAIL_ENCRYPTION=tls
        MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}
        MAIL_FROM_NAME="David's Wood Furniture"

        FILESYSTEM_DISK=s3
        AWS_ACCESS_KEY_ID=${{ secrets.AWS_S3_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_S3_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION=${{ secrets.AWS_S3_REGION }}
        AWS_BUCKET=${{ secrets.AWS_S3_BUCKET }}
        AWS_URL=
        AWS_ENDPOINT=
        AWS_USE_PATH_STYLE_ENDPOINT=false
        EOF
          echo "New .env file created with database settings"
        fi
        
        # Verify the .env file has database settings
        echo "Verifying .env file database settings:"
        grep "DB_" .env || echo "Still no DB_ settings found in .env"
        
        # Create and fix file permissions for Laravel
        echo "Creating and fixing Laravel file permissions..."
        sudo mkdir -p /var/www/.config/psysh || echo "Config directory creation attempted"
        sudo chown -R www-data:www-data /var/www/.config || echo "Config directory ownership fix attempted"
        sudo chmod -R 755 /var/www/.config || echo "Config permissions fix attempted"
        
        # Also create Laravel storage directories
        sudo mkdir -p /var/www/html/davids-wood-furniture/storage/logs || echo "Storage logs directory creation attempted"
        sudo mkdir -p /var/www/html/davids-wood-furniture/storage/framework/cache || echo "Cache directory creation attempted"
        sudo mkdir -p /var/www/html/davids-wood-furniture/storage/framework/sessions || echo "Sessions directory creation attempted"
        sudo mkdir -p /var/www/html/davids-wood-furniture/storage/framework/views || echo "Views directory creation attempted"
        sudo chown -R www-data:www-data /var/www/html/davids-wood-furniture/storage || echo "Storage ownership fix attempted"
        sudo chmod -R 775 /var/www/html/davids-wood-furniture/storage || echo "Storage permissions fix attempted"
        
        # Fix application directory permissions
        echo "Fixing application directory permissions..."
        sudo chown -R www-data:www-data /var/www/html/davids-wood-furniture || echo "Application ownership fix attempted"
        sudo chmod -R 755 /var/www/html/davids-wood-furniture || echo "Application permissions fix attempted"
        
        # Check database connection before running Laravel commands
        echo "Checking database connection..."
        echo "Database config:"
        sudo -u www-data php artisan tinker --execute="echo 'DB_HOST: ' . config('database.connections.mysql.host'); echo 'DB_DATABASE: ' . config('database.connections.mysql.database'); echo 'DB_USERNAME: ' . config('database.connections.mysql.username');"
        
        echo "Testing MySQL connection with localhost..."
        mysql -h localhost -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "SELECT 1;" || echo "Direct MySQL connection with localhost failed"
        
        echo "Testing MySQL connection with 127.0.0.1..."
        mysql -h 127.0.0.1 -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "SELECT 1;" || echo "Direct MySQL connection with 127.0.0.1 failed"
        
        # Test both connections work after user creation
        echo "Verifying both localhost and 127.0.0.1 connections work..."
        mysql -h localhost -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "SELECT 'localhost connection works' as test;" || echo "localhost connection failed"
        mysql -h 127.0.0.1 -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "SELECT '127.0.0.1 connection works' as test;" || echo "127.0.0.1 connection failed"
        
        echo "Checking if database exists with localhost..."
        mysql -h localhost -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "SHOW DATABASES;" || echo "Cannot list databases with localhost"
        
        echo "Checking if user can access the specific database with localhost..."
        mysql -h localhost -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "USE davids_wood; SHOW TABLES;" || echo "Cannot access davids_wood database with localhost"
        
        echo "Testing Laravel database connection..."
        sudo -u www-data php artisan tinker --execute="DB::connection()->getPdo(); echo 'Database connection successful';" || echo "Database connection failed, but continuing..."
        
        # Additional database debugging
        echo "Checking Laravel database configuration in detail..."
        sudo -u www-data php artisan tinker --execute="
        echo 'DB_HOST: ' . config('database.connections.mysql.host');
        echo 'DB_DATABASE: ' . config('database.connections.mysql.database');
        echo 'DB_USERNAME: ' . config('database.connections.mysql.username');
        echo 'DB_PORT: ' . config('database.connections.mysql.port');
        echo 'DB_CONNECTION: ' . config('database.default');
        "
        
        # Force complete configuration reset
        echo "Forcing complete configuration reset..."
        
        # Remove all cached configuration files
        sudo rm -rf /var/www/html/davids-wood-furniture/bootstrap/cache/config.php || echo "Config cache removal attempted"
        sudo rm -rf /var/www/html/davids-wood-furniture/storage/framework/cache/data/* || echo "Cache data removal attempted"
        sudo rm -rf /var/www/html/davids-wood-furniture/storage/framework/views/* || echo "View cache removal attempted"
        
        # Clear ALL Laravel caches
        sudo -u www-data php artisan config:clear || echo "Config clear failed, but continuing..."
        sudo -u www-data php artisan route:clear || echo "Route clear failed, but continuing..."
        sudo -u www-data php artisan view:clear || echo "View clear failed, but continuing..."
        sudo -u www-data php artisan cache:clear || echo "Cache clear failed, but continuing..."
        
        # Force reload .env file
        echo "Forcing .env file reload..."
        sudo -u www-data php artisan config:cache || echo "Config cache failed, but continuing..."
        
        # Verify the configuration is actually using localhost
        echo "Verifying Laravel is using localhost for database..."
        sudo -u www-data php artisan tinker --execute="
        echo 'Final DB_HOST check: ' . config('database.connections.mysql.host');
        if (config('database.connections.mysql.host') === 'localhost') {
            echo 'SUCCESS: Laravel is using localhost';
        } else {
            echo 'ERROR: Laravel is still using: ' . config('database.connections.mysql.host');
        }
        "
        
        # Run Laravel commands with error handling
        echo "Running Laravel commands..."
        sudo -u www-data php artisan migrate --force || echo "Migration failed, but continuing..."
        sudo -u www-data php artisan config:cache || echo "Config cache failed, but continuing..."
        # Skip route:cache for now due to subdomain route conflicts
        echo "Skipping route:cache due to subdomain route conflicts..."
        sudo -u www-data php artisan view:cache || echo "View cache failed, but continuing..."
        sudo -u www-data php artisan queue:restart || echo "Queue restart failed, but continuing..."
        
        # Restart all web services to ensure fresh configuration
        echo "Restarting web services..."
        sudo systemctl restart apache2 || echo "Apache restart failed, but continuing..."
        sudo systemctl restart php8.1-fpm || echo "PHP-FPM restart failed, but continuing..."
        sudo systemctl restart mysql || echo "MySQL restart failed, but continuing..."
        
        # Final Laravel cache clear after service restart
        echo "Final Laravel cache clear..."
        sudo -u www-data php artisan config:clear || echo "Final config clear failed, but continuing..."
        sudo -u www-data php artisan cache:clear || echo "Final cache clear failed, but continuing..."
        sudo -u www-data php artisan view:clear || echo "Final view clear failed, but continuing..."
        
        # Test deployment and check website
        echo "Testing deployment..."
        sleep 5
        
        # Check if the main website is working
        echo "Checking main website..."
        curl -I "http://localhost" || echo "Main website check failed"
        
        # Check Apache configuration and document root
        echo "Checking Apache configuration..."
        sudo apache2ctl -S || echo "Apache config check failed"
        
        # Check if Apache is serving the right directory
        echo "Checking Apache document root..."
        sudo grep -r "DocumentRoot" /etc/apache2/ || echo "No DocumentRoot found"
        
        # Check if Laravel files are accessible
        echo "Checking Laravel files accessibility..."
        ls -la /var/www/html/davids-wood-furniture/public/ || echo "Laravel public directory not found"
        
        # Check PHP configuration
        echo "Checking PHP configuration..."
        php -v || echo "PHP version check failed"
        php -m | grep -i mysql || echo "MySQL extension not found"
        
        # Check if we need to configure Apache virtual host for Laravel
        echo "Checking if Apache virtual host is configured..."
        if [ ! -f /etc/apache2/sites-available/davids-wood-furniture.conf ]; then
          echo "Creating Apache virtual host configuration..."
          sudo tee /etc/apache2/sites-available/davids-wood-furniture.conf > /dev/null << 'EOF'
<VirtualHost *:80>
    ServerName davidswood.shop
    ServerAlias www.davidswood.shop admin.davidswood.shop
    DocumentRoot /var/www/html/davids-wood-furniture/public
    
    <Directory /var/www/html/davids-wood-furniture/public>
        AllowOverride All
        Require all granted
    </Directory>
    
    ErrorLog ${APACHE_LOG_DIR}/davids-wood-furniture_error.log
    CustomLog ${APACHE_LOG_DIR}/davids-wood-furniture_access.log combined
</VirtualHost>
EOF
          sudo a2ensite davids-wood-furniture.conf || echo "Site enable failed"
          sudo a2enmod rewrite || echo "Rewrite module enable failed"
          sudo systemctl reload apache2 || echo "Apache reload failed"
        else
          echo "Apache virtual host already configured"
        fi
        
        # Check Laravel logs for errors
        echo "Checking Laravel logs for errors..."
        sudo tail -20 /var/www/html/davids-wood-furniture/storage/logs/laravel.log || echo "No Laravel logs found"
        
        # Check Apache error logs
        echo "Checking Apache error logs..."
        sudo tail -10 /var/log/apache2/error.log || echo "No Apache error logs found"
        
        if curl -f "http://localhost/health" >/dev/null 2>&1; then
          echo "✅ Health check passed"
        else
          echo "❌ Health check failed"
          sudo systemctl status apache2
          sudo tail -20 /var/log/apache2/error.log
          exit 1
        fi
        
        # Cleanup
        echo "Cleaning up..."
        sudo rm -rf /tmp/davids-wood-furniture-deploy
        
        echo "🎉 Deployment completed successfully!"
        DEPLOY_EOF

    - name: Post-deployment health check
      run: |
        sleep 10
        if curl -f "http://${{ secrets.EC2_HOST }}/health" >/dev/null 2>&1; then
          echo "✅ External health check passed"
        else
          echo "❌ External health check failed"
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo systemctl status apache2 && sudo tail -20 /var/log/apache2/error.log"
          exit 1
        fi