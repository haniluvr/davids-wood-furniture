name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options: [production, staging]

jobs:
  deploy:
    # Only run if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build assets
      run: npm run build

    - name: Download frontend build artifacts (if available)
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: public/build/
      continue-on-error: true

    - name: Verify frontend build
      run: |
        if [ -d "public/build" ] && [ "$(ls -A public/build 2>/dev/null)" ]; then
          echo "‚úÖ Using CI artifacts"
        else
          echo "‚ö†Ô∏è CI artifacts not available, will build fresh assets"
          # Ensure build directory exists
          mkdir -p public/build
        fi

    - name: Prepare SSH key
      shell: bash
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
        chmod 600 key.pem
        sed -i 's/\r$//' key.pem
        # More lenient key validation
        if ! head -1 key.pem | grep -q "BEGIN"; then
          echo "Warning: Key format may be invalid, but continuing..."
        fi
        mkdir -p ~/.ssh
        # Add host to known_hosts with error handling
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || echo "Warning: Could not add host to known_hosts"

    - name: Deploy to EC2
      timeout-minutes: 5
      run: |
        # Create .env file from secrets
        cat > .env << 'EOF'
        APP_NAME="David's Wood Furniture"
        APP_ENV=production
        APP_DEBUG=false
        APP_KEY=${{ secrets.APP_KEY }}
        APP_URL=${{ secrets.APP_URL }}

        DB_CONNECTION=mysql
        DB_HOST=localhost
        DB_PORT=3306
        DB_DATABASE=davids_wood
        DB_USERNAME=davidswood_user
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}

        REDIS_HOST=127.0.0.1
        REDIS_PORT=6379
        REDIS_PASSWORD=

        MAIL_MAILER=smtp
        MAIL_HOST=${{ secrets.MAIL_HOST }}
        MAIL_PORT=${{ secrets.MAIL_PORT }}
        MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
        MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
        MAIL_ENCRYPTION=tls
        MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}
        MAIL_FROM_NAME=${{ secrets.MAIL_FROM_NAME }}

        LOG_CHANNEL=stack
        LOG_DEPRECATIONS_CHANNEL=null
        LOG_LEVEL=error
        BROADCAST_DRIVER=log
        CACHE_DRIVER=redis
        QUEUE_CONNECTION=redis
        SESSION_DRIVER=redis
        SESSION_LIFETIME=1440
        FILESYSTEM_DISK=s3
        AWS_ACCESS_KEY_ID=${{ secrets.AWS_S3_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_S3_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION=${{ secrets.AWS_S3_REGION }}
        AWS_BUCKET=${{ secrets.AWS_S3_BUCKET }}

        EOF

        # Test EC2 connection first
        echo "Testing EC2 connection..."
        echo "EC2 Host: ${{ secrets.EC2_HOST }}"
        echo "EC2 User: ${{ secrets.EC2_USER }}"
        echo "Testing connectivity..."
        
        # Test SSH connection (skip ping as it's often blocked)
        echo "Testing SSH connection..."
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          -o ConnectTimeout=15 -o ServerAliveInterval=5 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'EC2 connection successful'"
        
        # Create target directory and copy files in one go
        echo "Creating directory and copying files..."
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          -o ConnectTimeout=15 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p /tmp/davids-wood-furniture-deploy"
        
        # Copy source code and essential assets (exclude heavy directories)
        echo "Copying source code to EC2..."
        rsync -avz --progress \
          --exclude='node_modules' \
          --exclude='vendor' \
          --exclude='.git' \
          --exclude='storage/logs' \
          --exclude='storage/framework/cache' \
          --exclude='storage/framework/sessions' \
          --exclude='storage/framework/views' \
          --exclude='database/*.sqlite' \
          --exclude='database/*.sql' \
          --exclude='public/build' \
          --include='public/admin/**' \
          --include='database/migrations/**' \
          --include='database/seeders/**' \
          --include='database/factories/**' \
          -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem -o ConnectTimeout=15" \
          ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/davids-wood-furniture-deploy/

        # Execute deployment on EC2
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOY_EOF'
        #!/bin/bash
        set -e
        
        echo "üöÄ Starting deployment on EC2..."
        
        APP_DIR="/var/www/html/davids-wood-furniture"
        DEPLOY_DIR="/tmp/davids-wood-furniture-deploy"
        
        # Create backup
        echo "Creating backup..."
        if [ -d "$APP_DIR" ]; then
          sudo cp -r "$APP_DIR" "${APP_DIR}_backup_$(date +%Y%m%d_%H%M%S)"
        fi
        
        # Stop Apache temporarily
        echo "Stopping Apache..."
        sudo systemctl stop apache2
        
        # Update application files
        echo "Updating application files..."
        sudo rm -rf "$APP_DIR"
        sudo mv "$DEPLOY_DIR" "$APP_DIR"
        
        # Set proper ownership and permissions
        echo "Setting file permissions..."
        sudo chown -R www-data:www-data "$APP_DIR"
        sudo chmod -R 755 "$APP_DIR"
        sudo chmod -R 775 "$APP_DIR/storage"
        sudo chmod -R 775 "$APP_DIR/bootstrap/cache"
        
        # Ensure composer can write to the directory
        echo "Setting up composer permissions..."
        sudo chmod -R 775 "$APP_DIR"
        sudo chown -R www-data:www-data "$APP_DIR"
        
        # Install PHP dependencies
        echo "Installing PHP dependencies..."
        cd "$APP_DIR"
        sudo -u www-data composer install --no-dev --optimize-autoloader --no-interaction
        
        # Fix npm permissions and create clean environment
        echo "Setting up npm environment..."
        sudo rm -rf /var/www/.npm /var/www/.npmrc /tmp/.npm
        sudo mkdir -p /tmp/.npm
        sudo chown -R www-data:www-data /tmp/.npm
        
        # Set npm environment variables for www-data
        echo "Configuring npm environment..."
        sudo -u www-data bash -c 'export NPM_CONFIG_CACHE=/tmp/.npm && export NPM_CONFIG_PREFIX=/tmp/.npm-global && npm ci'
        
        echo "Building frontend assets..."
        sudo -u www-data bash -c 'export NPM_CONFIG_CACHE=/tmp/.npm && export NPM_CONFIG_PREFIX=/tmp/.npm-global && npm run build'
        
        # Ensure MySQL is running
        echo "Checking MySQL status..."
        sudo systemctl status mysql || echo "MySQL status check failed"
        sudo systemctl start mysql || echo "MySQL start failed"
        
        # Check current .env file on server
        echo "Current .env file database settings:"
        grep "DB_" .env || echo "No DB_ settings found in .env"
        
        # Fix file permissions for Laravel
        echo "Fixing Laravel file permissions..."
        sudo chown -R www-data:www-data /var/www/.config || echo "Config directory fix attempted"
        sudo chmod -R 755 /var/www/.config || echo "Config permissions fix attempted"
        
        # Check database connection before running Laravel commands
        echo "Checking database connection..."
        echo "Database config:"
        sudo -u www-data php artisan tinker --execute="echo 'DB_HOST: ' . config('database.connections.mysql.host'); echo 'DB_DATABASE: ' . config('database.connections.mysql.database'); echo 'DB_USERNAME: ' . config('database.connections.mysql.username');"
        
        echo "Testing MySQL connection with localhost..."
        mysql -h localhost -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "SELECT 1;" || echo "Direct MySQL connection with localhost failed"
        
        echo "Testing MySQL connection with 127.0.0.1..."
        mysql -h 127.0.0.1 -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "SELECT 1;" || echo "Direct MySQL connection with 127.0.0.1 failed"
        
        echo "Checking if database exists with localhost..."
        mysql -h localhost -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "SHOW DATABASES;" || echo "Cannot list databases with localhost"
        
        echo "Checking if user can access the specific database with localhost..."
        mysql -h localhost -u davidswood_user -p${{ secrets.DB_PASSWORD }} -e "USE davids_wood; SHOW TABLES;" || echo "Cannot access davids_wood database with localhost"
        
        echo "Testing Laravel database connection..."
        sudo -u www-data php artisan tinker --execute="DB::connection()->getPdo(); echo 'Database connection successful';" || echo "Database connection failed, but continuing..."
        
        # Run Laravel commands with error handling
        echo "Running Laravel commands..."
        sudo -u www-data php artisan migrate --force || echo "Migration failed, but continuing..."
        sudo -u www-data php artisan config:cache || echo "Config cache failed, but continuing..."
        sudo -u www-data php artisan route:clear || echo "Route clear failed, but continuing..."
        sudo -u www-data php artisan route:cache || echo "Route cache failed, but continuing..."
        sudo -u www-data php artisan view:cache || echo "View cache failed, but continuing..."
        sudo -u www-data php artisan queue:restart || echo "Queue restart failed, but continuing..."
        
        # Start Apache
        echo "Starting Apache..."
        sudo systemctl start apache2
        
        # Test deployment
        echo "Testing deployment..."
        sleep 5
        if curl -f "http://localhost/health" >/dev/null 2>&1; then
          echo "‚úÖ Health check passed"
        else
          echo "‚ùå Health check failed"
          sudo systemctl status apache2
          sudo tail -20 /var/log/apache2/error.log
          exit 1
        fi
        
        # Cleanup
        echo "Cleaning up..."
        sudo rm -rf /tmp/davids-wood-furniture-deploy
        
        echo "üéâ Deployment completed successfully!"
        DEPLOY_EOF

    - name: Post-deployment health check
      run: |
        sleep 10
        if curl -f "http://${{ secrets.EC2_HOST }}/health" >/dev/null 2>&1; then
          echo "‚úÖ External health check passed"
        else
          echo "‚ùå External health check failed"
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo systemctl status apache2 && sudo tail -20 /var/log/apache2/error.log"
          exit 1
        fi